'use client';import {useEffect,useMemo,useState} from 'react';type Customer={id:string;name:string;vat_number:string;city:string;price_tier:'A'|'B'|'C'};type Product={id:string;sku:string;name:string;unit:string;stock:number;price:number|null};type OrderLine={productId:string;qty:number;unitPrice:number};function fmt(n:number){return new Intl.NumberFormat('el-GR',{style:'currency',currency:'EUR'}).format(n);}export default function Home(){const [customers,setCustomers]=useState<Customer[]>([]);const [products,setProducts]=useState<Product[]>([]);const [customerId,setCustomerId]=useState('');const [query,setQuery]=useState('');const [lines,setLines]=useState<OrderLine[]>([]);const [notes,setNotes]=useState('');const [lastOrderId,setLastOrderId]=useState<number|null>(null);const [loading,setLoading]=useState(false);const customer=useMemo(()=>customers.find(c=>c.id===customerId)||null,[customerId,customers]);const filtered=useMemo(()=>{const q=query.toLowerCase().trim();return products.filter(p=>p.name.toLowerCase().includes(q)||p.sku.toLowerCase().includes(q));},[products,query]);const totals=useMemo(()=>{const net=lines.reduce((s,l)=>s+l.qty*l.unitPrice,0);const vat=net*0.24;return {net,vat,gross:net+vat};},[lines]);useEffect(()=>{fetch('/api/customers').then(r=>r.json()).then(setCustomers);},[]);useEffect(()=>{const tier=customer?.price_tier||'C';fetch(`/api/products?tier=${tier}`).then(r=>r.json()).then(setProducts);},[customer?.price_tier]);function add(p:Product){const price=p.price??0;setLines(prev=>{const e=prev.find(l=>l.productId===p.id);if(e)return prev.map(l=>l.productId===p.id?{...l,qty:l.qty+1}:l);return[...prev,{productId:p.id,qty:1,unitPrice:price}]});}function setQty(id:string,q:number){setLines(prev=>prev.map(l=>l.productId===id?{...l,qty:Math.max(0,q)}:l).filter(l=>l.qty>0));}function rm(id:string){setLines(prev=>prev.filter(l=>l.productId!==id));}async function submit(){if(!customer||!lines.length)return;setLoading(true);const res=await fetch('/api/orders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({customerId:customer.id,notes,lines})});setLoading(false);if(!res.ok){alert('Σφάλμα');return;}const data=await res.json();setLastOrderId(data.id);setLines([]);setNotes('');}return(<div className='container py-8 space-y-6'><header className='flex items-center justify-between'><div><h1 className='text-3xl font-semibold'>B2B Orders</h1><p className='text-sm text-gray-500'>Supabase + Next.js</p></div><div className='flex gap-2'><a className='btn' href='/admin/customers'>Admin Πελάτες</a><a className='btn' href='/admin/products'>Admin Προϊόντα</a></div></header><div className='grid grid-cols-1 lg:grid-cols-3 gap-6'><div className='space-y-6'><div className='card'><div className='card-hd'><div className='text-lg font-medium'>Πελάτης</div></div><div className='card-bd space-y-3'><label className='text-sm'>Επιλογή πελάτη</label><select className='input' value={customerId} onChange={e=>setCustomerId(e.target.value)}><option value=''>— Επιλέξτε —</option>{customers.map(c=>(<option key={c.id} value={c.id}>{c.name} • {c.city}</option>))}</select>{!customer?<p className='text-sm text-gray-500'>Δεν έχει επιλεγεί πελάτης.</p>:(<div className='rounded-xl bg-gray-50 p-3 text-sm'><div><span className='text-gray-500'>Τιμοκατάλογος:</span> <span className='badge'>{customer.price_tier}</span></div><div><span className='text-gray-500'>ΑΦΜ:</span> {customer.vat_number}</div></div>)}</div></div><div className='card'><div className='card-hd'><div className='text-lg font-medium'>Αναζήτηση προϊόντων</div></div><div className='card-bd'><div className='flex gap-2'><input className='input' placeholder='π.χ. 5L ή OLV-1000' value={query} onChange={e=>setQuery(e.target.value)} /><button className='btn' onClick={()=>setQuery('')}>Καθαρισμός</button></div></div></div></div><div className='space-y-6'><div className='card'><div className='card-hd'><div className='text-lg font-medium'>Προϊόντα</div></div><div className='card-bd overflow-x-auto'><table className='table'><thead><tr><th>SKU</th><th>Προϊόν</th><th className='text-right'>Τιμή</th><th className='text-right'>Απόθεμα</th><th className='text-right'>Προσθήκη</th></tr></thead><tbody>{filtered.map(p=>(<tr key={p.id} className='hover:bg-gray-50'><td className='font-mono text-xs'>{p.sku}</td><td>{p.name}<div className='text-xs text-gray-500'>{p.unit}</div></td><td className='text-right'>{p.price!=null?fmt(p.price):'—'}</td><td className='text-right'>{p.stock}</td><td className='text-right'><button className='btn' disabled={!customer} onClick={()=>add(p)}>+</button></td></tr>))}</tbody></table></div></div></div><div className='space-y-6'><div className='card'><div className='card-hd'><div className='text-lg font-medium'>Καλάθι</div></div><div className='card-bd space-y-4'>{!lines.length?<p className='text-sm text-gray-500'>Δεν υπάρχουν γραμμές.</p>:(<div className='space-y-2'>{lines.map(l=>{const p=products.find(pp=>pp.id===l.productId)!;return(<div key={l.productId} className='flex items-center justify-between rounded-xl border border-gray-200 p-3'><div><div className='font-medium'>{p.name}</div><div className='text-xs text-gray-500'>{p.sku} • {fmt(l.unitPrice)} / {p.unit}</div></div><div className='flex items-center gap-2'><button className='btn' onClick={()=>setQty(l.productId,Math.max(0,l.qty-1))}>-</button><input type='number' className='input' style={{width:'5rem',textAlign:'center'}} value={l.qty} onChange={e=>setQty(l.productId,Number(e.target.value))} /><button className='btn' onClick={()=>setQty(l.productId,l.qty+1)}>+</button><button className='btn' onClick={()=>rm(l.productId)}>Διαγραφή</button></div></div>);})}<div className='separator'></div><div className='text-sm space-y-1'><div className='flex justify-between'><span>Καθαρή αξία</span><span>{fmt(totals.net)}</span></div><div className='flex justify-between' style={{color:'#6b7280'}}><span>ΦΠΑ 24%</span><span>{fmt(totals.vat)}</span></div><div className='flex justify-between' style={{fontWeight:600}}><span>Σύνολο</span><span>{fmt(totals.gross)}</span></div></div><div className='space-y-1'><label className='text-sm'>Σημειώσεις</label><input className='input' value={notes} onChange={e=>setNotes(e.target.value)} /></div><button className='btn btn-primary w-full' disabled={!customer||!lines.length||loading} onClick={submit}>{loading?'Αποστολή…':'Υποβολή παραγγελίας'}</button>{lastOrderId&&<a className='link' href={`/api/orders/${lastOrderId}/pdf`} target='_blank'>Λήψη PDF παραγγελίας #{lastOrderId}</a>}</div>)}</div></div></div></div>);}
